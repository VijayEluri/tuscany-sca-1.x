<!--
    * Licensed to the Apache Software Foundation (ASF) under one
    * or more contributor license agreements.  See the NOTICE file
    * distributed with this work for additional information
    * regarding copyright ownership.  The ASF licenses this file
    * to you under the Apache License, Version 2.0 (the
    * "License"); you may not use this file except in compliance
    * with the License.  You may obtain a copy of the License at
    * 
    *   http://www.apache.org/licenses/LICENSE-2.0
    * 
    * Unless required by applicable law or agreed to in writing,
    * software distributed under the License is distributed on an
    * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    * KIND, either express or implied.  See the License for the
    * specific language governing permissions and limitations
    * under the License.    
-->
<html>
<head>
<title>SCA Tours</title>

<link rel="stylesheet" type="text/css" href="style.css" />

<script type="text/javascript" src="scatours.js"></script>

<script language="JavaScript">   
	
    //@Reference
    var scaToursSearch = new Reference("scaToursSearch");
    
    //@Reference
    var scaToursBooking = new Reference("scaToursBooking");
        
    //local state
    var currentCartId;
    var tripIds = [];
    var currentTripIdIndex = -1;
    var searchItems;
    var cartItems;
         
    //the constructor for trip leg beans
    function TripLegType(id,
                         fromLocation,
                         toLocation,
                         fromDate,
                         toDate,
                         noOfPeople) {
          this.id           = id;
          this.fromLocation = fromLocation;
          this.toLocation   = toLocation;
          this.fromDate     = fromDate;
          this.toDate       = toDate;
          this.noOfPeople   = noOfPeople;
    }
    
    function getTripLeg(){
        return new TripLegType(tripIds[currentTripIdIndex],
                               document.travelForm.fromLocation.value,
                               document.travelForm.toLocation.value,
                               document.travelForm.fromDate.value,
                               document.travelForm.toDate.value,
                               document.travelForm.noOfPeople.value);
    }
		
    function init() {
	   try {
           addCart(); 
	   }
	   catch(e) {
	       alert(e);
	   }
    }
            
    function searchTravelCatalog() {        
        scaToursSearch.search(getTripLeg(), search_response);
    }
        
    function search_response(items, exception) {
        if(exception){
            alert(exception.javaStack);
            return;
        }
        var responseHTML = '<table border="0">';
        responseHTML    += '<tr>';
        responseHTML    += '<td>Select</td><td>Name</td><td>Description</td><td>Location</td><td>From - To</td><td>Price</td>';
        responseHTML    += '</tr>';
        
        for (var i=0; i<items.length; i++) {
            responseHTML += '<tr>';
            responseHTML += '<td><input onClick="processSelection()" name="items" type="checkbox" value="' + items[i].id + '"></td>'
            responseHTML += '<td>' +  items[i].name + '</td>';
            responseHTML += '<td>' +  items[i].description + '</td>';
            responseHTML += '<td>' +  items[i].location + '</td>';
            responseHTML += '<td>' +  items[i].fromDate + ' - ' + items[i].toDate +'</td>';
            responseHTML += '<td>' +  items[i].price + ' ' + items[i].currency + '</td>';
            responseHTML += '</tr>';
        }
        
        responseHTML    += '</table>';
        
        document.getElementById('searchResponse').innerHTML = responseHTML;
        
        searchItems = items;
    }  
    
    function processSelection() {
        // do nothing at the moment
    }
         
    function addItemsToCart() {     
        var items  = document.tripForm.items;

        for (var i=0; i<items.length; i++) {
            
            // notify the server of the change
            if (items[i].checked == true) {
                scaToursBooking.addTripItem(currentCartId, tripIds[currentTripIdIndex], items[i].value);
            } else {
                scaToursBooking.removeTripItem(currentCartId, tripIds[currentTripIdIndex], items[i].value);
            }
        }
        
        scaToursBooking.getTripItems(currentCartId, getTripItems_response);
    }
    
    function getTripItems() {
        scaToursBooking.getTripItems(currentCartId, getTripItems_response);
    }
    
    function getTripItems_response(items, exception) {
        if(exception){
            alert(exception.javaStack);
            return;
        }
        var itemsHTML = '';
        
        for (var x=0; x<=currentTripIdIndex; x++){
            var tripId = tripIds[x]
            itemsHTML += '<h3>Trip - ' + tripId + '</h3>';
            itemsHTML += '<table border="0">';
            itemsHTML += '<tr>';
            itemsHTML += '<td>Name</td><td>Description</td><td>Location</td><td>From - To</td><td>Price</td>';
            itemsHTML += '</tr>';
            
            for (var i=0; i<items.length; i++) {
                if (items[i].tripId == tripId) {
                    itemsHTML += '<tr>';
                    itemsHTML += '<td>' +  items[i].name + '</td>';
                    itemsHTML += '<td>' +  items[i].description + '</td>';
                    itemsHTML += '<td>' +  items[i].location + '</td>';
                    itemsHTML += '<td>' +  items[i].fromDate + ' - ' + items[i].toDate +'</td>';
                    itemsHTML += '<td>' +  items[i].price + ' ' + items[i].currency + '</td>';
                    itemsHTML += '</tr>';
                }
            }
            
            itemsHTML    += '</table>';
        }
        
        document.getElementById('tripItems').innerHTML = itemsHTML;  
          
        scaToursBooking.getTotalPrice(currentCartId, getTotalPrice_response);
    }    
    
    function getTotalPrice_response(totalPrice, exception) {
        if(exception){
            alert(exception.javaStack);
            return;
        }
        document.getElementById('totalPrice').innerHTML = totalPrice;
    }
    
    function addCart() { 
        scaToursBooking.addCart(addCart_response);
        
        document.getElementById('searchResponse').innerHTML = "";
        document.getElementById('tripItems').innerHTML = "";
        document.getElementById('totalPrice').innerHTML = "";
        currentTripIdIndex = -1;
        tripIds = [];
    }
    
    function addCart_response(cartId, exception) { 
        if(exception){
            alert(exception.javaStack);
            return;
        }
        currentCartId = cartId
        
        if (currentTripIdIndex == -1){
            addTrip();
        }
    }    
    
    function addTrip() { 
        scaToursBooking.addTrip(currentCartId, addTrip_response);
    }
    
    function addTrip_response(tripId, exception) { 
        if(exception){
            alert(exception.javaStack);
            return;
        }
        currentTripIdIndex++;
        tripIds[currentTripIdIndex] = tripId;
        getTripItems();
    }    
    
    function checkout() {        
        scaToursBooking.checkout(currentCartId);
        
        document.getElementById('searchResponse').innerHTML = "";
        document.getElementById('tripItems').innerHTML = "Thank you for shopping with SCA Tours";
        document.getElementById('totalPrice').innerHTML = "";
        searchResponseItems = null;
        tripItems = null;
    }   
    
    function purchase() { 
    }
	
</script>

</head>

<body onload="init()" background="">
	<img src="scatours.png" border="0" />
	<div id="scatours">
        <form name="travelForm"> 
            <h3>Search for hotels, flights and cars</h3>
            <br/>
            <table border="0">
                <tr>
                    <td>From Location:</td>
                    <td><input type="text" name="fromLocation" value="LGW"></td>
                    <td>To Location:</td>
                    <td><input type="text" name="toLocation" value="ANU"></td>
                </tr>
                <tr>
                    <td>Start Date:</td>
                    <td><input type="text" name="fromDate" value="06/12/08"></td>
                    <td>End Date:</td>
                    <td><input type="text" name="toDate" value="13/12/08"></td>
                </tr>
                <tr>
                    <td>Number of people:</td>
                    <td><select name="noOfPeople">
                        <option>1
                        <option selected>2
                        <option>3
                        <option>4
                    </select></td>
                    <td/>
                    <td/>
                </tr>
            </table>
            <br/>
            <input type="button" onClick="searchTravelCatalog()" value="Search"> 
        </form>
        <form name="tripForm">
            <h3>Search Results</h3> 
            <div id="searchResponse"></div>
            <br/> 
            <input type="button" onClick="addItemsToCart()" value="Add Items"> 
            <br/>
            <h3>Shopping Cart</h3>
            <h3><div id="cartId"></h3>
            <div id="tripItems"></div>
            <br/>
            <h3>Cart Totals</h3>            
            Total Price: <div id="totalPrice"></div>
            <br/>    
            <input type="button" onClick="addCart()" value="Reset Cart">         
            <input type="button" onClick="addTrip()" value="Create New Trip"> 
            <input type="button" onClick="checkout()" value="Checkout"> 
        </form> 
	</div>
  
</body>
</html>
