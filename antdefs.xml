<!--
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *   http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
-->

<!--
   This file is designed to be imported by build.xml files to provide
   definitions for a default set of build targets.  The build.xml file
   can include additional definitions to configure the behavior of these
   default targets.  The build.xml file can also define any additional
   targets that are needed by the project.

   When invoking a build.xml file that imports this file, the following
   environment variables must be set:
     TUSCANY_HOME A directory containing the Tuscany binary distribution.
     JUNIT_JAR The location of the JUnit jar file.  The JUnit version used
       for testing these build files was JUnit 4.5.

   This file defines the following targets that can be used on the
   ant command that invokes the build.xml file:
     <compile> Compiles any Java source files that don't have an up-to-date
       class file, and copies any files in or under the resource directory.
       If the build.xml file contains a <path> element with the id
       "compile-path", the contents of this path are added to the compiler's
       classpath.  Also invokes the following targets:
       . <wsdljava> (defined in the build.xml file) if there are any
           .wsdl files in or under the resource directory
       . <test> if there are any files in or under the src/test/java
           directory
       . <package> if all previous steps completed successfully
     <test> Compiles any Java unit test files that don't have an
       up-to-date class file, copies any test resources in or under
       the src/test/resources directory, and runs the unit tests.
       If the build.xml file contains a <path> element with the id
       "test-path", the contents of this path are added to the unit test
       classpath.  If the build.xml file defines the "test-setup" property,
       the <test-setup> target in the build.xml file is invoked after
       copying the test resources.
     <package> Creates a jar file containing the compiled Java class
        files (excluding unit test code) and any files in or under the
        resource directory, unless the jar file is already up to date.
     <clean> Deletes all the files produced by the build.

   This file also defines the following targets for invocation by <antcall>
   within the <wsdljava> target in the build.xml file:
     <wsimport> Generates Java code from a WSDL file (unless the Java
       code is already up to date) by running the JDK wsimport command.
       Requires the following parameters:
       . <package> the Java package to use for generated code
       . <wsdlfile> the filename of the WSDL file
       . <javaclass> the filename of any Java class file that will be
           generated by running wsimport on the WSDL file
     <sdojavagen> Generates Java code from a WSDL file (unless the Java
       code is already up to date) by running the SDO XSD2JavaGenerator.
       Requires the same parameters as <wsimport>, plus the following:
       . <prefix> the prefix string for naming the generated factory
   The build.xml file can make any number of calls to <wsimport> and/or
   <sdojavagen>.

   All other targets defined by this file (with names starting with "#")
   are for internal use from within this file and are not intended to
   be used externally.
-->

<project name="antdefs">
    <property environment="env"/> 

    <!-- check whether there are any WSDL files in or under the resource directory -->
    <target name="#find-wsdlfiles">
        <fileset id="#allwsdl" dir="src/main/resources">
            <include name="**/*.wsdl"/>
        </fileset>
        <condition property="#wsdlfiles">
            <and>
                <available file="src/main/resources" type="dir"/>
                <resourcecount refid="#allwsdl" when="greater" count="0"/>
            </and>
        </condition>
    </target>

    <!-- call the wsdljava target in the build.xml file if required -->
    <target name="#call-wsdljava" depends="#find-wsdlfiles" if="#wsdlfiles">
        <antcall target="wsdljava"/>
    </target>

    <!-- check whether the WSDL-generated Java code is already up to date -->
    <target name="#wsdlcheck">
        <condition property="#wsdl-uptodate">
            <uptodate srcfile="src/main/resources/${wsdlfile}"
                      targetfile="target/classes/${javaclass}"/>
        </condition>
    </target>

    <!-- run the JDK wsimport command if required -->
    <target name="wsimport" depends="#wsdlcheck" unless="#wsdl-uptodate">
        <mkdir dir="target/jaxws-source"/>
        <exec executable="${java.home}/../bin/wsimport">
            <arg line="-keep -s ./target/jaxws-source -p ${package} 
                       -d ./target/classes src/main/resources/${wsdlfile}"/>
        </exec>
	</target>

    <!-- run the SDO XSD2JavaGenerator if required, then compile the generated Java source -->
    <target name="sdojavagen" depends="#wsdlcheck" unless="#wsdl-uptodate">
        <mkdir dir="target/sdo-source"/>
        <java classname="org.apache.tuscany.sdo.generate.XSD2JavaGenerator" fork="yes" dir=".">
            <arg value="-javaPackage"/>
            <arg value="${package}"/>
            <arg value="-prefix"/>
            <arg value="${prefix}"/>
            <arg value="-noNotification"/>
            <arg value="-noContainment"/>
            <arg value="-noUnsettable"/>
            <arg value="-targetDirectory"/>
            <arg value="target/sdo-source"/>
            <arg value="src/main/resources/${wsdlfile}"/>
            <classpath>
                <pathelement path="${env.TUSCANY_HOME}/lib/tuscany-sca-manifest.jar"/>
            </classpath>
        </java>
        <javac destdir="target/classes" debug="on" source="1.5" target="1.5">
            <src path="target/sdo-source"/>
            <classpath>
                <pathelement path="${env.TUSCANY_HOME}/lib/tuscany-sca-manifest.jar"/>
            </classpath>
        </javac>
    </target>

    <!-- check whether there are any Java source files to compile -->
    <target name="#find-javafiles">
        <fileset id="#alljava" dir="src/main/java">
            <include name="**/*.java"/>
        </fileset>
        <condition property="#javafiles">
            <and>
                <available file="src/main/java" type="dir"/>
                <resourcecount refid="#alljava" when="greater" count="0"/>
            </and>
        </condition>
    </target>

    <!-- check whether a dependency path for the Java compiler was specified -->
    <target name="#check-compile-path">
        <condition property="#compile-path">
            <isreference refid="compile-path"/>
        </condition>
    </target>

    <!-- set classpath for Java compiler to include specified additional path -->
    <target name="#set-classpath" depends="#check-compile-path" if="#compile-path">
        <path id="#javac-classpath">
            <path refid="compile-path"/>
        </path>
    </target>

    <!-- set default classpath for Java compiler if no additional path specified -->
    <target name="#default-classpath" depends="#check-compile-path" unless="#compile-path">
        <path id="#javac-classpath"/>
    </target>

    <!-- compile the Java source files -->
    <target name="#compile-src" depends="#find-javafiles, #set-classpath, #default-classpath" if="#javafiles">
        <javac destdir="target/classes" debug="on" source="1.5" target="1.5">
            <src path="src/main/java"/>
            <classpath>
                <path refid="#javac-classpath"/>
                <pathelement path="${env.TUSCANY_HOME}/lib/tuscany-sca-manifest.jar"/>
            </classpath>
        </javac>
    </target>

    <!-- check whether there are any resources to copy -->
    <target name="#find-resources">
        <fileset id="#allresources" dir="src/main/resources"/>
        <condition property="#resources">
            <and>
                <available file="src/main/resources" type="dir"/>
                <resourcecount refid="#allresources" when="greater" count="0"/>
            </and>
        </condition>
    </target>

    <!-- copy the contents of the resource directory -->
    <target name="#copy-resources" depends="#find-resources" if="#resources">
        <copy todir="target/classes">
            <fileset dir="src/main/resources"/>
        </copy>
    </target>

    <!-- check whether there are any Java files in or under the test directory -->
    <target name="#find-testjava">
        <fileset id="#alltestjava" dir="src/test/java">
            <include name="**/*.java"/>
        </fileset>
        <condition property="#testjava">
            <and>
                <available file="src/test/java" type="dir"/>
                <resourcecount refid="#alltestjava" when="greater" count="0"/>
            </and>
        </condition>
    </target>

    <!-- call the test target if required -->
    <target name="#call-test" depends="#find-testjava" if="#testjava">
        <antcall target="test"/>
    </target>

    <!-- check whether there are any test resources to copy -->
    <target name="#find-testresources">
        <fileset id="#alltestresources" dir="src/test/resources"/>
        <condition property="#testresources">
            <and>
                <available file="src/test/resources" type="dir"/>
                <resourcecount refid="#alltestresources" when="greater" count="0"/>
            </and>
        </condition>
    </target>

    <!-- copy the test resources -->
    <target name="#copy-testresources" depends="#find-testresources" if="#testresources">
        <copy todir="target/test-classes">
            <fileset dir="src/test/resources"/>
        </copy>
    </target>

    <!-- perform additional test setup if required -->
    <target name="#test-setup" if="test-setup">
        <antcall target="test-setup"/>
    </target>

    <!-- check whether a dependency path for the unit tests was specified -->
    <target name="#check-test-path">
        <condition property="#test-path">
            <isreference refid="test-path"/>
        </condition>
    </target>

    <!-- set classpath for unit tests to include specified additional path -->
    <target name="#set-test-classpath" depends="#check-test-path" if="#test-path">
        <path id="#test-classpath">
            <path refid="test-path"/>
        </path>
    </target>

    <!-- set default classpath for unit tests if no additional path specified -->
    <target name="#default-test-classpath" depends="#check-test-path" unless="#test-path">
        <path id="#test-classpath"/>
    </target>

    <!-- run the junit task -->
    <target name="#run-junit" depends="#set-test-classpath, #default-test-classpath">
        <junit printsummary="no" haltonfailure="yes" dir="."
               fork="yes" forkmode="once">
            <classpath>
                <pathelement location="target/test-classes"/>
                <pathelement location="target/classes"/>
                <path refid="#test-classpath"/>
                <pathelement location="${env.TUSCANY_HOME}/lib/tuscany-sca-manifest.jar"/>
                <pathelement location="${env.JUNIT_JAR}"/>
            </classpath>
            <formatter type="plain" usefile="false"/>
            <batchtest>
                <fileset dir="src/test/java">
                    <include name="**/*TestCase.java"/>
                </fileset>
            </batchtest>
        </junit>
    </target>

    <!-- check whether there are any files in the webapp directory -->
    <target name="#check-webapp">
        <fileset id="#webappfiles" dir="src/main/webapp"/>
        <condition property="#webapp">
            <and>
                <available file="src/main/webapp" type="dir"/>
                <resourcecount refid="#webappfiles" when="greater" count="0"/>
            </and>
        </condition>
    </target>

    <!-- build a war file if there are files in the webapp directory -->
    <target name="#package-war" depends="#check-webapp" if="#webapp">
        <fileset id="#tuscanyjars" dir="${env.TUSCANY_HOME}/modules">
            <include name="tuscany-node-api-*.jar"/>
            <include name="tuscany-node-launcher-*.jar"/>
            <include name="tuscany-sca-api-*.jar"/>
            <exclude name="tuscany-sca-api-extension-*.jar"/>
        </fileset>
        <war destfile="target/${ant.project.name}.war" webxml="src/main/webapp/WEB-INF/web.xml">
            <fileset dir="src/main/webapp"/>
            <lib refid="#tuscanyjars"/>
            <classes dir="target/classes"/>
        </war>
    </target>

    <!-- build a jar file if there are no files in the webapp directory -->
    <target name="#package-jar" depends="#check-webapp" unless="#webapp">
        <jar destfile="target/${ant.project.name}.jar"
             basedir="target/classes"/>
    </target>

    <!-- for external use on the ant command line -->
    <target name="compile">
        <mkdir dir="target/classes"/>
        <antcall target="#call-wsdljava"/>
        <antcall target="#compile-src"/>
        <antcall target="#copy-resources"/>
        <antcall target="#call-test"/>
        <antcall target="package"/>
    </target>

    <!-- for external use on the ant command line -->
    <target name="test" depends="#find-testjava, #set-test-classpath, #default-test-classpath" if="#testjava">
        <mkdir dir="target/test-classes"/>
        <javac destdir="target/test-classes" debug="on" source="1.5" target="1.5">
            <src path="src/test/java"/>
            <classpath>
                <pathelement location="target/classes"/>
                <path refid="#test-classpath"/>
                <pathelement location="${env.TUSCANY_HOME}/lib/tuscany-sca-manifest.jar"/>
                <pathelement location="${env.JUNIT_JAR}"/>
            </classpath>
        </javac>
        <antcall target="#copy-testresources"/>
        <antcall target="#test-setup"/>
        <antcall target="#run-junit"/>
    </target>

    <!-- for external use on the ant command line -->
    <target name="package" depends="#package-war, #package-jar"/>

    <!-- for external use on the ant command line -->
    <target name="clean">
        <delete dir="target" includeemptydirs="true"/>
    </target>

</project>
